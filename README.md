Workflow AI Platformæ­¡è¿ä¾†åˆ° Workflow AI Platformï¼é€™æ˜¯ä¸€å€‹ç¾ä»£åŒ–çš„å…¨ç«¯æ‡‰ç”¨ç¨‹å¼ï¼Œæ—¨åœ¨é€éäººå·¥æ™ºæ…§æŠ€è¡“ç°¡åŒ–æ‚¨çš„æ–‡ä»¶ç®¡ç†å’ŒèªéŸ³äº’å‹•å·¥ä½œæµç¨‹ã€‚æœ¬å°ˆæ¡ˆæ•´åˆäº† robust çš„ Laravel å¾Œç«¯ã€éŸ¿æ‡‰è¿…é€Ÿçš„ Vue3 å‰ç«¯å’Œå¼·å¤§çš„ FastAPI AI å¾®æœå‹™ï¼Œä¸¦é€é Docker Compose å¯¦ç¾ä¾¿æ·çš„å®¹å™¨åŒ–éƒ¨ç½²ã€‚ğŸš€ å°ˆæ¡ˆäº®é» (Project Highlights)å…¨ç«¯æ•´åˆ: ç„¡ç¸«å”ä½œçš„ Laravel (PHP) å¾Œç«¯ã€Vue3 (JavaScript) å‰ç«¯å’Œ FastAPI (Python) AI å¾®æœå‹™ã€‚æ™ºæ…§æ–‡ä»¶ç®¡ç†:æ–‡ä»¶ä¸Šå‚³èˆ‡è™•ç†: æ”¯æ´ PDF, DOCX, TXT æ–‡ä»¶ä¸Šå‚³ã€‚AI æ‘˜è¦: åˆ©ç”¨ OpenAI çš„å¤§å‹èªè¨€æ¨¡å‹ (LLM) è‡ªå‹•ç‚ºæ–‡ä»¶ç”Ÿæˆç²¾ç°¡æ‘˜è¦ã€‚èªæ„æœå°‹: åŸºæ–¼æ–‡ä»¶å…§å®¹çš„å‘é‡åŒ– (OpenAI Embedding) å¯¦ç¾é«˜ç²¾åº¦çš„èªæ„æœå°‹ï¼Œå¿«é€Ÿæ‰¾åˆ°ç›¸é—œè³‡è¨Šã€‚AI èªéŸ³åŠ©ç†:é«˜æ•ˆèªéŸ³è½‰éŒ„: æ•´åˆ Faster-Whisper æ¨¡å‹ï¼Œå°‡èªéŸ³è¼¸å…¥å¿«é€Ÿè½‰æ›ç‚ºæ–‡å­—ã€‚RAG (æª¢ç´¢å¢å¼·ç”Ÿæˆ): å°‡è½‰éŒ„æ–‡å­—èˆ‡æª¢ç´¢åˆ°çš„æ–‡ä»¶å…§å®¹çµåˆï¼Œé€é OpenAI LLM ç”Ÿæˆé€£è²«ã€ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ™ºæ…§å›æ‡‰ã€‚å°è©±æ­·å²: å®Œæ•´è¨˜éŒ„ç”¨æˆ¶èˆ‡ AI åŠ©ç†çš„èªéŸ³äº’å‹•æ­·å²ã€‚å®‰å…¨èªè­‰: æ¡ç”¨ Laravel Sanctum å¯¦ç¾å®‰å…¨çš„ API èªè­‰å’Œè·¨åŸŸ (CORS) å…¼å®¹ã€‚è³‡æ–™æŒä¹…åŒ–: ä½¿ç”¨ MySQL å„²å­˜æ‡‰ç”¨æ•¸æ“šï¼ŒQdrant ä½œç‚ºé«˜æ•ˆèƒ½å‘é‡è³‡æ–™åº«ã€‚è‡ªå‹•åŒ– API æ–‡æª”: é€é Laravel Scribe è‡ªå‹•ç”Ÿæˆæ¸…æ™°ã€äº’å‹•æ€§å¼·çš„ API æ–‡æª”ã€‚å…¨é¢æ¸¬è©¦: åŒ…å«å‰ç«¯ (Vitest å–®å…ƒæ¸¬è©¦ã€Cypress E2E æ¸¬è©¦) å’Œå¾Œç«¯ (PHPUnit) æ¸¬è©¦ï¼Œç¢ºä¿æ‡‰ç”¨ç¨‹å¼çš„ç©©å®šæ€§å’Œå¯é æ€§ã€‚ä¾¿æ·éƒ¨ç½²: åŸºæ–¼ Docker Compose çš„å®¹å™¨åŒ–æ–¹æ¡ˆï¼Œå¯¦ç¾å¿«é€Ÿæ­å»ºå’Œéƒ¨ç½²é–‹ç™¼ç’°å¢ƒã€‚ğŸŒ³ å°ˆæ¡ˆçµæ§‹ (Project Structure)æœ¬å°ˆæ¡ˆæ¡ç”¨å¾®æœå‹™æ¶æ§‹ï¼Œæ¸…æ™°åŠƒåˆ†è·è²¬ï¼šworkflow-ai-platform/
â”œâ”€â”€ .env.example              # ç’°å¢ƒè®Šæ•¸ç¯„æœ¬
â”œâ”€â”€ Caddyfile                 # Caddy åå‘ä»£ç†é…ç½®
â”œâ”€â”€ README.md                 # å°ˆæ¡ˆèªªæ˜æ–‡ä»¶ (æ‚¨æ­£åœ¨é–±è®€çš„æª”æ¡ˆ)
â”œâ”€â”€ docker-compose.yml        # Docker Compose æœå‹™å®šç¾©
â”œâ”€â”€ backend/                  # Laravel å¾Œç«¯æ‡‰ç”¨ç¨‹å¼
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ Http/Controllers/   # API æ§åˆ¶å™¨ (AuthController, DocumentController, VoiceController)
â”‚   â”‚   â””â”€â”€ Models/             # Eloquent æ¨¡å‹ (User, Document, Voice)
â”‚   â”œâ”€â”€ config/scribe.php       # Scribe API æ–‡æª”é…ç½®
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ migrations/         # è³‡æ–™åº«é·ç§»æª”æ¡ˆ
â”‚   â”‚   â””â”€â”€ seeders/            # è³‡æ–™åº«ç¨®å­æª”æ¡ˆ (DocumentSeeder, VoiceSeeder, UserSeeder)
â”‚   â”œâ”€â”€ nginx/default.conf      # Nginx æœå‹™é…ç½®
â”‚   â”œâ”€â”€ etc/supervisor/         # Supervisor é€²ç¨‹ç®¡ç†é…ç½®
â”‚   â”œâ”€â”€ routes/api.php          # API è·¯ç”±å®šç¾©
â”‚   â””â”€â”€ tests/Feature/          # å¾Œç«¯ API æ¸¬è©¦
â”œâ”€â”€ frontend/                 # Vue3 å‰ç«¯æ‡‰ç”¨ç¨‹å¼
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ assets/             # éœæ…‹è³‡æº
â”‚   â”‚   â”œâ”€â”€ components/         # å¯é‡ç”¨çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ router/index.js     # Vue Router é…ç½®
â”‚   â”‚   â”œâ”€â”€ stores/             # Pinia ç‹€æ…‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ views/              # é é¢ç´šçµ„ä»¶
â”‚   â”‚   â””â”€â”€ App.vue, main.js    # Vue æ‡‰ç”¨å…¥å£
â”‚   â”œâ”€â”€ cypress/                # Cypress E2E æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ e2e/                # E2E æ¸¬è©¦è…³æœ¬
â”‚   â”‚   â””â”€â”€ fixtures/           # æ¸¬è©¦æ•¸æ“š
â”‚   â”œâ”€â”€ package.json            # å‰ç«¯ä¾è³´å’Œè…³æœ¬
â”‚   â””â”€â”€ vite.config.js          # Vite é…ç½®
â”œâ”€â”€ ai-orchestrator/          # FastAPI AI å¾®æœå‹™
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ services/           # AI æ ¸å¿ƒæœå‹™ (document_service, rag_pipeline)
â”‚   â”‚   â”œâ”€â”€ models/             # æ•¸æ“šæ¨¡å‹
â”‚   â”‚   â””â”€â”€ main.py             # FastAPI æ‡‰ç”¨å…¥å£
â”‚   â”œâ”€â”€ data/                   # Faster-Whisper æ¨¡å‹ä¸‹è¼‰ç›®éŒ„
â”‚   â”œâ”€â”€ requirements.txt        # Python ä¾è³´
â”‚   â””â”€â”€ tests/                  # AI å¾®æœå‹™æ¸¬è©¦
â””â”€â”€ db_data/                  # MySQL è³‡æ–™æŒä¹…åŒ–ç›®éŒ„
â””â”€â”€ qdrant_data/              # Qdrant è³‡æ–™æŒä¹…åŒ–ç›®éŒ„
ğŸ’» é—œéµç¨‹å¼ç¢¼è§£æ (Key Code Analysis with Comments)æœ¬ç¯€å°‡æ·±å…¥æ¢è¨å°ˆæ¡ˆä¸­çš„é—œéµç¨‹å¼ç¢¼ç‰‡æ®µï¼Œå±•ç¤ºå…¶æ ¸å¿ƒé‚è¼¯å’ŒæŠ€è¡“å¯¦ç¾ã€‚A. å¾Œç«¯æœå‹™ (Laravel)Laravel å¾Œç«¯è² è²¬ç”¨æˆ¶èªè­‰ã€API è·¯ç”±ç®¡ç†ã€æ–‡ä»¶å„²å­˜ä»¥åŠèˆ‡ AI å¾®æœå‹™çš„å”èª¿æºé€šã€‚1. ç”¨æˆ¶èªè­‰ - backend/app/Http/Controllers/AuthController.phpæ­¤æ§åˆ¶å™¨è™•ç†ç”¨æˆ¶çš„è¨»å†Šå’Œç™»å…¥é‚è¼¯ï¼Œä¸¦åˆ©ç”¨ Laravel Sanctum ç”Ÿæˆ API Tokenã€‚<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use App\Models\User;
use Illuminate\Validation\ValidationException;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;

/**
 * @group Authentication
 *
 * ç®¡ç†ç”¨æˆ¶è¨»å†Šã€ç™»å…¥å’Œç™»å‡ºã€‚
 */
class AuthController extends Controller
{
    /**
     * è¨»å†Šæ–°ç”¨æˆ¶ã€‚
     *
     * è¨»å†Šä¸€å€‹æ–°ç”¨æˆ¶ä¸¦è¿”å› Sanctum API Tokenã€‚
     * @bodyParam name string required ç”¨æˆ¶åã€‚Example: John Doe
     * @bodyParam email string required ç”¨æˆ¶çš„ Email åœ°å€ï¼Œå¿…é ˆæ˜¯å”¯ä¸€çš„ã€‚Example: john@example.com
     * @bodyParam password string required ç”¨æˆ¶å¯†ç¢¼ï¼Œè‡³å°‘8å€‹å­—ç¬¦ï¼Œä¸”éœ€è¦èˆ‡ password_confirmation åŒ¹é…ã€‚Example: password123
     * @bodyParam password_confirmation string required ç¢ºèªç”¨æˆ¶å¯†ç¢¼ã€‚Example: password123
     */
    public function register(Request $request)
    {
        try {
            // é©—è­‰è¼¸å…¥æ•¸æ“š
            $request->validate([
                'name' => 'required|string|max:255',
                'email' => 'required|string|email|max:255|unique:users', // Email å¿…é ˆå”¯ä¸€
                'password' => 'required|string|min:8|confirmed', // å¯†ç¢¼è‡³å°‘8ä½ä¸”éœ€è¦ç¢ºèª
            ]);
        } catch (ValidationException $e) {
            Log::error('è¨»å†Šé©—è­‰å¤±æ•—: ' . json_encode($e->errors()));
            return response()->json(['message' => 'è¨»å†Šé©—è­‰å¤±æ•—', 'errors' => $e->errors()], 422);
        }

        // å‰µå»ºæ–°ç”¨æˆ¶
        $user = User::create([
            'name' => $request->name,
            'email' => $request->email,
            'password' => Hash::make($request->password), // å¯†ç¢¼åŠ å¯†å„²å­˜
        ]);

        // ç‚ºæ–°ç”¨æˆ¶å‰µå»º Sanctum API Token
        $token = $user->createToken('auth_token')->plainTextToken;

        Log::info("ç”¨æˆ¶ {$user->email} è¨»å†ŠæˆåŠŸã€‚");
        return response()->json([
            'message' => 'User registered successfully',
            'token' => $token,
            'user' => $user
        ], 201); // è¿”å› 201 Created ç‹€æ…‹ç¢¼
    }

    /**
     * ç”¨æˆ¶ç™»å…¥ã€‚
     *
     * é©—è­‰ç”¨æˆ¶æ†‘è­‰ä¸¦è¿”å› Sanctum API Tokenã€‚
     * @bodyParam email string required ç”¨æˆ¶çš„ Email åœ°å€ã€‚Example: john@example.com
     * @bodyParam password string required ç”¨æˆ¶å¯†ç¢¼ã€‚Example: password123
     */
    public function login(Request $request)
    {
        try {
            // é©—è­‰è¼¸å…¥æ•¸æ“š
            $request->validate([
                'email' => 'required|string|email',
                'password' => 'required|string',
            ]);
        } catch (ValidationException $e) {
            Log::error('ç™»å…¥é©—è­‰å¤±æ•—: ' . json_encode($e->errors()));
            return response()->json(['message' => 'ç™»å…¥é©—è­‰å¤±æ•—', 'errors' => $e->errors()], 422);
        }

        // å˜—è©¦ä½¿ç”¨ Email å’Œå¯†ç¢¼é€²è¡Œèªè­‰
        if (!Auth::attempt($request->only('email', 'password'))) {
            Log::warning("ç™»å…¥å˜—è©¦å¤±æ•—ï¼šç„¡æ•ˆçš„æ†‘è­‰ï¼ŒEmail: {$request->email}");
            return response()->json(['message' => 'Invalid credentials'], 401); // èªè­‰å¤±æ•—è¿”å› 401 Unauthorized
        }

        // ç²å–èªè­‰å¾Œçš„ç”¨æˆ¶å¯¦ä¾‹
        $user = $request->user();
        // ç‚ºç”¨æˆ¶å‰µå»ºæ–°çš„ Sanctum API Token
        $token = $user->createToken('auth_token')->plainTextToken;

        Log::info("ç”¨æˆ¶ {$user->email} ç™»å…¥æˆåŠŸã€‚");
        return response()->json([
            'message' => 'Login successful',
            'token' => $token,
            'user' => $user
        ]);
    }

    // ... (logout å’Œ user æ–¹æ³•ä¹Ÿåœ¨æ­¤æ§åˆ¶å™¨ä¸­ï¼Œé‚è¼¯é¡ä¼¼)
}
2. æ–‡ä»¶è™•ç† - backend/app/Http/Controllers/DocumentController.phpæ­¤æ§åˆ¶å™¨è² è²¬æ¥æ”¶æ–‡ä»¶ä¸Šå‚³ï¼Œå°‡å…¶å„²å­˜ï¼Œç„¶å¾Œè§¸ç™¼ AI å¾®æœå‹™é€²è¡Œæ·±åº¦è™•ç†ï¼ˆå‘é‡åŒ–å’Œæ‘˜è¦ï¼‰ã€‚<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support->Facades\Storage;
use Illuminate->Support->Facades\Http; // ç”¨æ–¼ç™¼é€ HTTP è«‹æ±‚åˆ° AI Orchestrator
use App\Models\Document;
use Illuminate\Validation\ValidationException;
use Illuminate->Support->Facades\Log;

/**
 * @group Document Management
 *
 * ç®¡ç†æ–‡ä»¶çš„ä¸Šå‚³ã€æœå°‹å’Œè™•ç†ã€‚
 */
class DocumentController extends Controller
{
    /**
     * ä¸Šå‚³æ–‡ä»¶ã€‚
     *
     * å…è¨±ç”¨æˆ¶ä¸Šå‚³æ–‡ä»¶ (PDF, DOCX, TXT)ï¼Œæ–‡ä»¶å°‡è¢«å„²å­˜ï¼Œä¸¦è§¸ç™¼ AI å¾®æœå‹™é€²è¡Œå‘é‡åŒ–å’Œæ‘˜è¦ã€‚
     * @authenticated
     * @bodyParam file file required The file to upload (max 10MB, allowed types: pdf, doc, docx, txt).
     * @bodyParam category string The category of the document. Example: "Policy"
     */
    public function upload(Request $request)
    {
        try {
            // é©—è­‰æ–‡ä»¶å’Œåˆ†é¡è¼¸å…¥
            $request->validate([
                'file' => 'required|file|mimes:pdf,doc,docx,txt|max:10240', // é™åˆ¶æ–‡ä»¶é¡å‹å’Œå¤§å° (10MB)
                'category' => 'nullable|string|max:255'
            ]);
        } catch (ValidationException $e) {
            Log::error('æ–‡ä»¶ä¸Šå‚³é©—è­‰å¤±æ•—: ' . json_encode($e->errors()));
            return response()->json(['message' => 'æ–‡ä»¶é©—è­‰å¤±æ•—', 'errors' => $e->errors()], 422);
        }

        $file = $request->file('file');
        $originalName = $file->getClientOriginalName();
        // å°‡æ–‡ä»¶å„²å­˜åˆ° Laravel çš„ storage/app/documents ç›®éŒ„
        $path = $file->store('documents'); 

        // å‰µå»ºæ–‡ä»¶è¨˜éŒ„åˆ°è³‡æ–™åº«ï¼Œç‹€æ…‹è¨­ç‚º 'pending_ai'
        $document = Document::create([
            'user_id' => $request->user()->id ?? null, // é—œè¯ä¸Šå‚³ç”¨æˆ¶
            'name' => $originalName,
            'file_path' => $path,
            'summary' => null, // æ‘˜è¦ç­‰å¾… AI æœå‹™å¡«å……
            'status' => 'pending_ai', 
            'category' => $request->input('category')
        ]);

        Log::info("æ–‡ä»¶ {$document->id} å·²ä¸Šå‚³ï¼Œæº–å‚™ç™¼é€è‡³ AI Orchestratorã€‚");

        try {
            // å‘ AI Orchestrator å¾®æœå‹™ç™¼é€ HTTP POST è«‹æ±‚ï¼Œè§¸ç™¼æ–‡ä»¶è™•ç†
            // å‚³éæ–‡ä»¶åœ¨å¾Œç«¯çš„çµ•å°è·¯å¾‘å’Œç›¸é—œå…ƒæ•¸æ“š
            $aiResponse = Http::timeout(120)->post(env('AI_ORCHESTRATOR_URL') . '/documents/upload', [
                'document_id' => $document->id,
                'file_path' => storage_path('app/' . $path), // æä¾›æ–‡ä»¶çš„çµ•å°è·¯å¾‘
                'metadata' => [
                    'original_name' => $originalName,
                    'category' => $document->category,
                    'uploaded_by' => $document->user_id,
                ]
            ]);

            if ($aiResponse->successful()) {
                $ai_result = $aiResponse->json();
                // å¦‚æœ AI è™•ç†æˆåŠŸï¼Œæ›´æ–°æ–‡ä»¶è¨˜éŒ„çš„æ‘˜è¦å’Œç‹€æ…‹
                $document->update([
                    'summary' => $ai_result['summary'] ?? null,
                    'status' => $ai_result['status'] ?? 'processed_ai',
                ]);
                Log::info("æ–‡ä»¶ {$document->id} AI è™•ç†æˆåŠŸã€‚");
            } else {
                // AI è™•ç†å¤±æ•—ï¼Œæ›´æ–°ç‹€æ…‹ä¸¦è¿”å›éŒ¯èª¤
                $document->update(['status' => 'ai_failed']);
                Log::error("AI Orchestrator æ–‡ä»¶è™•ç†å¤±æ•—ï¼Œæ–‡ä»¶ ID: {$document->id}ã€‚éŒ¯èª¤: " . $aiResponse->body());
                return response()->json(['message' => 'æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼Œä½†AIè™•ç†å¤±æ•—', 'error' => $aiResponse->body()], $aiResponse->status());
            }
        } catch (\GuzzleHttp\Exception\ConnectException $e) {
            // ç„¡æ³•é€£æ¥åˆ° AI Orchestrator
            $document->update(['status' => 'ai_connection_error']);
            Log::error("é€£æ¥ AI Orchestrator å¤±æ•—ï¼Œæ–‡ä»¶ ID: {$document->id}ã€‚éŒ¯èª¤: " . $e->getMessage());
            return response()->json(['message' => 'æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼Œä½†ç„¡æ³•é€£æ¥AIæœå‹™', 'error' => $e->getMessage()], 500);
        } catch (\Exception $e) {
            // å…¶ä»–æœªçŸ¥éŒ¯èª¤
            $document->update(['status' => 'ai_process_error']);
            Log::error("AI Orchestrator è™•ç†æ–‡ä»¶æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œæ–‡ä»¶ ID: {$document->id}ã€‚éŒ¯èª¤: " . $e->getMessage());
            return response()->json(['message' => 'æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼Œä½†AIè™•ç†ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤', 'error' => $e->getMessage()], 500);
        }

        return response()->json([
            'message' => 'æ–‡ä»¶å·²ä¸Šå‚³ä¸¦ç™¼é€è‡³AIè™•ç†',
            'document' => $document,
            'ai_response' => $ai_result ?? null
        ], 201);
    }
    
    // ... (search æ–¹æ³•ä¹Ÿåœ¨æ­¤æ§åˆ¶å™¨ä¸­ï¼Œé‚è¼¯é¡ä¼¼)
}
3. èªéŸ³åŠ©ç† - backend/app/Http/Controllers/VoiceController.phpæ­¤æ§åˆ¶å™¨è™•ç†èªéŸ³è¼¸å…¥ï¼Œå°‡å…¶ç™¼é€çµ¦ AI å¾®æœå‹™é€²è¡Œè½‰éŒ„å’Œå›æ‡‰ç”Ÿæˆï¼Œä¸¦ç®¡ç†å°è©±æ­·å²ã€‚<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support->Facades->Storage;
use Illuminate->Support->Facades->Http;
use App\Models\Voice;
use Illuminate->Validation\ValidationException;
use Illuminate->Support->Facades\Log;

/**
 * @group Voice Assistant
 *
 * æä¾›èªéŸ³è¼¸å…¥è™•ç†å’Œå°è©±æ­·å²è¨˜éŒ„åŠŸèƒ½ã€‚
 */
class VoiceController extends Controller
{
    /**
     * è™•ç†èªéŸ³è¼¸å…¥ã€‚
     *
     * æ¥æ”¶èªéŸ³æ–‡ä»¶ï¼Œå°‡å…¶ç™¼é€è‡³ AI å¾®æœå‹™é€²è¡Œè½‰éŒ„ï¼Œç„¶å¾Œä½¿ç”¨è½‰éŒ„æ–‡æœ¬ç²å– AI å›æ‡‰ï¼Œä¸¦å„²å­˜å°è©±æ­·å²ã€‚
     * @authenticated
     * @bodyParam audio file required The audio file to process (max 10MB, allowed types: mp3, wav, ogg, webm).
     * @bodyParam user_id string required The ID of the user. This should ideally come from an authenticated user. Example: "user_uuid_123"
     */
    public function process(Request $request)
    {
        try {
            // é©—è­‰éŸ³é »æ–‡ä»¶å’Œç”¨æˆ¶ ID
            $request->validate([
                'audio' => 'required|file|mimes:mp3,wav,ogg,webm|max:10240', // æ”¯æ´å¸¸è¦‹éŸ³é »æ ¼å¼ï¼Œæœ€å¤§10MB
                'user_id' => 'required|string', 
            ]);
        } catch (ValidationException $e) {
            Log::error('èªéŸ³æ–‡ä»¶é©—è­‰å¤±æ•—: ' . json_encode($e->errors()));
            return response()->json(['message' => 'èªéŸ³æ–‡ä»¶é©—è­‰å¤±æ•—', 'errors' => $e->errors()], 422);
        }

        $audioFile = $request->file('audio');
        // å„²å­˜ç”¨æˆ¶ä¸Šå‚³çš„éŸ³é »æ–‡ä»¶
        $filePath = $audioFile->store('voices'); 
        $userId = $request->input('user_id');

        Log::info("æ”¶åˆ°èªéŸ³è™•ç†è«‹æ±‚ï¼Œç”¨æˆ¶ID: {$userId}ï¼Œæ–‡ä»¶è·¯å¾‘: {$filePath}");

        try {
            // 1. è½‰éŒ„èªéŸ³ï¼šå°‡éŸ³é »æ–‡ä»¶ç™¼é€çµ¦ AI Orchestrator é€²è¡Œè½‰éŒ„
            Log::info("ç™¼é€èªéŸ³æª”è‡³ AI Orchestrator é€²è¡Œè½‰éŒ„...");
            $transcribeResponse = Http::timeout(60)->attach(
                'audio_file', file_get_contents(storage_path('app/' . $filePath)), $audioFile->getClientOriginalName()
            )->post(env('AI_ORCHESTRATOR_URL') . '/voice/transcribe');

            if (!$transcribeResponse->successful()) {
                Log::error("AI Orchestrator èªéŸ³è½‰éŒ„å¤±æ•—ã€‚éŒ¯èª¤: " . $transcribeResponse->body());
                return response()->json(['message' => 'èªéŸ³è½‰éŒ„å¤±æ•—', 'error' => $transcribeResponse->body()], $transcribeResponse->status());
            }
            $transcribedText = $transcribeResponse->json('transcribed_text');
            Log::info("èªéŸ³è½‰éŒ„æˆåŠŸ: '{$transcribedText}'");

            // 2. ç²å–å°è©±æ­·å²ï¼šå¾è³‡æ–™åº«ä¸­æª¢ç´¢ç•¶å‰ç”¨æˆ¶çš„å°è©±æ­·å²ï¼Œç”¨æ–¼ RAG çš„ä¸Šä¸‹æ–‡
            $history = Voice::where('user_id', $userId)
                             ->orderBy('created_at', 'asc')
                             ->select('speaker', 'text')
                             ->get()
                             ->map(function($item) {
                                 // æ ¼å¼åŒ–æ­·å²è¨Šæ¯ç‚º AI Orchestrator é æœŸçš„æ ¼å¼
                                 return ['role' => ($item->speaker == 'user' ? 'user' : 'assistant'), 'content' => $item->text];
                             })
                             ->toArray();
            Log::info("ç²å–åˆ°ç”¨æˆ¶ {$userId} çš„æ­·å²å°è©±æ•¸: " . count($history));

            // 3. ç”Ÿæˆå›æ‡‰ï¼šå°‡è½‰éŒ„æ–‡æœ¬å’Œæ­·å²å°è©±ç™¼é€çµ¦ AI Orchestrator ç²å–å›æ‡‰
            Log::info("ç™¼é€è½‰éŒ„æ–‡æœ¬è‡³ AI Orchestrator ç²å–å›æ‡‰...");
            $aiResponse = Http::timeout(120)->post(env('AI_ORCHESTRATOR_URL') . '/voice/respond', [
                'user_id' => $userId,
                'prompt' => $transcribedText,
                'conversation_history' => $history // å‚³éå°è©±æ­·å²
            ]);

            if (!$aiResponse->successful()) {
                Log::error("AI Orchestrator èªéŸ³å›æ‡‰å¤±æ•—ã€‚éŒ¯èª¤: " . $aiResponse->body());
                return response()->json(['message' => 'AI å›æ‡‰ç”Ÿæˆå¤±æ•—', 'error' => $aiResponse->body()], $aiResponse->status());
            }
            $responseText = $aiResponse->json('response_text');
            Log::info("AI å›æ‡‰ç”ŸæˆæˆåŠŸ: '{$responseText}'");

            // å„²å­˜ç”¨æˆ¶çš„èªéŸ³è¼¸å…¥å’Œ AI çš„æ–‡å­—å›æ‡‰åˆ°è³‡æ–™åº«ï¼Œä½œç‚ºå°è©±æ­·å²çš„ä¸€éƒ¨åˆ†
            Voice::create([
                'user_id' => $userId,
                'speaker' => 'user', // ç”¨æˆ¶ç™¼è¨€
                'text' => $transcribedText,
                'audio_path' => $filePath, // è¨˜éŒ„åŸå§‹èªéŸ³æ–‡ä»¶è·¯å¾‘
            ]);
            Voice::create([
                'user_id' => $userId,
                'speaker' => 'assistant', // åŠ©ç†å›æ‡‰
                'text' => $responseText,
                'audio_path' => null, // AI å›æ‡‰é€šå¸¸æ²’æœ‰èªéŸ³æª”
            ]);
            Log::info("å°è©±æ­·å²å·²å„²å­˜ã€‚");

            return response()->json([
                'message' => 'èªéŸ³è™•ç†æˆåŠŸ',
                'transcribed_text' => $transcribedText,
                'response_text' => $responseText,
            ]);

        } catch (\GuzzleHttp\Exception\ConnectException $e) {
            // é€£æ¥éŒ¯èª¤è™•ç†
            Log::error("é€£æ¥ AI Orchestrator å¤±æ•— (èªéŸ³è™•ç†)ã€‚éŒ¯èª¤: " . $e->getMessage());
            return response()->json(['message' => 'ç„¡æ³•é€£æ¥AIæœå‹™', 'error' => $e->getMessage()], 500);
        } catch (\Exception $e) {
            // å…¶ä»–æœªçŸ¥éŒ¯èª¤è™•ç†
            Log::error("è™•ç†èªéŸ³æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: " . $e->getMessage());
            return response()->json(['message' => 'èªéŸ³è™•ç†æœå‹™ç•°å¸¸', 'error' => $e->getMessage()], 500);
        }
    }

    // ... (history æ–¹æ³•ä¹Ÿåœ¨æ­¤æ§åˆ¶å™¨ä¸­ï¼Œé‚è¼¯é¡ä¼¼)
}
4. è³‡æ–™åº«é·ç§» - backend/database/migrations/é·ç§»æ–‡ä»¶å®šç¾©äº†è³‡æ–™åº«è¡¨çš„çµæ§‹ã€‚*_create_documents_table.php<?php

use Illuminate->Database->Migrations->Migration;
use Illuminate->Database->Schema->Blueprint;
use Illuminate->Support->Facades->Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('documents', function (Blueprint $table) {
            $table->id(); // ä¸»éµ ID
            $table->foreignId('user_id')->nullable()->constrained('users')->onDelete('set null'); // ç”¨æˆ¶ ID å¤–éµï¼Œå…è¨±ç‚ºç©º (å¦‚æœæ–‡ä»¶ä¸èˆ‡ç‰¹å®šç”¨æˆ¶é—œè¯)
            $table->string('name'); // æ–‡ä»¶åŸå§‹åç¨±
            $table->string('file_path'); // æ–‡ä»¶åœ¨ä¼ºæœå™¨å„²å­˜çš„è·¯å¾‘
            $table->text('summary')->nullable(); // AI ç”Ÿæˆçš„æ–‡ä»¶æ‘˜è¦ï¼Œå…è¨±ç‚ºç©º
            $table->string('status')->default('uploaded'); // æ–‡ä»¶è™•ç†ç‹€æ…‹ (uploaded, pending_ai, processed_ai, ai_failed, etc.)
            $table->string('category')->nullable(); // æ–‡ä»¶åˆ†é¡ï¼Œä¾‹å¦‚ "Contract", "Report"
            $table->timestamps(); // created_at å’Œ updated_at æ™‚é–“æˆ³
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('documents');
    }
};
*_create_voices_table.php<?php

use Illuminate->Database->Migrations->Migration;
use Illuminate->Database->Schema->Blueprint;
use Illuminate->Support->Facades->Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('voices', function (Blueprint $table) {
            $table->id(); // ä¸»éµ ID
            $table->foreignId('user_id')->constrained('users')->onDelete('cascade'); // ç”¨æˆ¶ ID å¤–éµï¼Œé—œè¯ç”¨æˆ¶ï¼Œç”¨æˆ¶åˆªé™¤æ™‚å°è©±è¨˜éŒ„ä¹Ÿåˆªé™¤
            $table->enum('speaker', ['user', 'assistant']); // ç™¼è¨€è€…è§’è‰²ï¼š'user' æˆ– 'assistant'
            $table->text('text'); // è½‰éŒ„å¾Œçš„æ–‡å­— (ç”¨æˆ¶) æˆ– AI å›æ‡‰çš„æ–‡å­— (åŠ©ç†)
            $table->string('audio_path')->nullable(); // åŸå§‹èªéŸ³æ–‡ä»¶è·¯å¾‘ (åƒ…é™ç”¨æˆ¶ç™¼è¨€)ï¼Œå…è¨±ç‚ºç©º
            $table->timestamps(); // created_at å’Œ updated_at æ™‚é–“æˆ³
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('voices');
    }
};
B. AI å¾®æœå‹™ (FastAPI)AI å¾®æœå‹™æ˜¯å°ˆæ¡ˆçš„æ ¸å¿ƒï¼Œè² è²¬æ‰€æœ‰çš„ AI ç›¸é—œè™•ç†ï¼ŒåŒ…æ‹¬ Embeddingã€æ‘˜è¦ã€RAG å’ŒèªéŸ³è½‰éŒ„ã€‚1. OpenAI Embedding èˆ‡æ‘˜è¦ - ai-orchestrator/app/services/document_service.pyæ­¤æœå‹™è™•ç†æ–‡ä»¶çš„ Embedding ç”Ÿæˆå’Œå…§å®¹æ‘˜è¦ï¼Œä¸¦èˆ‡ Qdrant å‘é‡è³‡æ–™åº«äº¤äº’ã€‚import os
import logging
from dotenv import load_dotenv
from typing import List, Dict, Any

from qdrant_client import QdrantClient, models
from langchain_community.embeddings import OpenAIEmbeddings # å¾ LangChain å°å…¥ OpenAI Embedding
from langchain_openai import ChatOpenAI # å¾ LangChain å°å…¥ OpenAI Chat æ¨¡å‹
from langchain.text_splitter import RecursiveCharacterTextSplitter # ç”¨æ–¼æ–‡æœ¬åˆ†å‰²

logger = logging.getLogger(__name__)

# å¾ç’°å¢ƒè®Šæ•¸è¼‰å…¥é…ç½®
load_dotenv()
QDRANT_HOST = os.getenv("QDRANT_HOST", "qdrant")
QDRANT_PORT = int(os.getenv("QDRANT_PORT", 6333))
COLLECTION_NAME = "documents_collection"
EMBEDDING_DIM = 1536 # OpenAI text-embedding-ada-002 çš„å‘é‡ç¶­åº¦

# åˆå§‹åŒ– Qdrant å®¢æˆ¶ç«¯
client = QdrantClient(host=QDRANT_HOST, port=QDRANT_PORT)

# åˆå§‹åŒ– OpenAI Embedding å’Œ ChatOpenAI æ¨¡å‹
embeddings_model = None
chat_llm = None
try:
    openai_api_key = os.getenv("OPENAI_API_KEY")
    if openai_api_key:
        embeddings_model = OpenAIEmbeddings(openai_api_key=openai_api_key) # åˆå§‹åŒ– Embedding æ¨¡å‹
        chat_llm = ChatOpenAI(temperature=0.7, openai_api_key=openai_api_key) # åˆå§‹åŒ– Chat æ¨¡å‹
        logger.info("OpenAI Embedding and ChatOpenAI models initialized.")
    else:
        logger.warning("OPENAI_API_KEY æœªè¨­å®šï¼ŒOpenAI æœå‹™å°‡ç„¡æ³•å·¥ä½œã€‚")
except Exception as e:
    logger.error(f"åˆå§‹åŒ– OpenAI æ¨¡å‹å¤±æ•—: {e}. è«‹æª¢æŸ¥ OPENAI_API_KEYã€‚", exc_info=True)


async def get_embedding(text: str) -> List[float]:
    """
    ä½¿ç”¨ OpenAIEmbeddings ç²å–æ–‡æœ¬ Embedding (å‘é‡è¡¨ç¤º)ã€‚
    """
    if embeddings_model is None:
        raise RuntimeError("OpenAI Embedding æ¨¡å‹æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚")
    try:
        embedding = embeddings_model.embed_query(text) # èª¿ç”¨ OpenAI API ç”Ÿæˆ Embedding
        return embedding
    except Exception as e:
        logger.error(f"ç²å– Embedding å¤±æ•—: {e}", exc_info=True)
        raise RuntimeError(f"Embedding æœå‹™éŒ¯èª¤: {e}")

async def process_document_embedding(document_id: int, file_path: str, metadata: Dict[str, Any]) -> str:
    """
    è™•ç†æ–‡ä»¶ï¼šè®€å–å…§å®¹ï¼Œåˆ†å‰²ç‚ºå¡Šï¼Œå‘é‡åŒ–ï¼Œä¸¦å„²å­˜åˆ° Qdrantã€‚
    åŒæ™‚ç”Ÿæˆæ–‡ä»¶æ‘˜è¦ã€‚
    """
    await initialize_qdrant_collection() # ç¢ºä¿ Qdrant Collection å­˜åœ¨

    content = ""
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read() # è®€å–æ–‡ä»¶å…§å®¹ (ç›®å‰å‡è¨­ç‚ºç´”æ–‡æœ¬)

    # ä½¿ç”¨ LangChain çš„éæ­¸å­—ç¬¦æ–‡æœ¬åˆ†å‰²å™¨ï¼Œå°‡é•·æ–‡æœ¬åˆ†å‰²æˆè¼ƒå°çš„å¡Š
    text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)
    chunks = text_splitter.split_text(content)
    
    points = []
    for i, chunk in enumerate(chunks):
        embedding = await get_embedding(chunk) # ç‚ºæ¯å€‹æ–‡æœ¬å¡Šç”Ÿæˆ Embedding
        points.append(
            models.PointStruct(
                id=f"{document_id}_{i}", # å‰µå»ºå”¯ä¸€çš„é» ID
                vector=embedding,
                payload={"document_id": document_id, "chunk_index": i, "text": chunk, **metadata} # å„²å­˜å…ƒæ•¸æ“šå’ŒåŸå§‹æ–‡æœ¬å¡Š
            )
        )
    
    if points:
        client.upsert(
            collection_name=COLLECTION_NAME,
            points=points,
            wait=True 
        ) # å°‡æ‰€æœ‰é»æ’å…¥æˆ–æ›´æ–°åˆ° Qdrant

    summary = await summarize_document(document_id, content) # ç”Ÿæˆæ–‡ä»¶æ‘˜è¦
    return summary

async def summarize_document(document_id: int, text_content: str) -> str:
    """
    ä½¿ç”¨ ChatOpenAI å°æ–‡æœ¬å…§å®¹é€²è¡Œæ‘˜è¦ã€‚
    """
    if chat_llm is None:
        raise RuntimeError("OpenAI Chat LLM æ¨¡å‹æœªè¼‰å…¥ï¼Œç„¡æ³•åŸ·è¡Œæ‘˜è¦ã€‚")
    try:
        # æˆªæ–·è¼¸å…¥æ–‡æœ¬ä»¥ç¬¦åˆ LLM çš„ token é™åˆ¶
        max_input_length = 4000 
        truncated_content = text_content[:max_input_length] + ("..." if len(text_content) > max_input_length else "")

        prompt = f"è«‹ç°¡æ½”ã€æ¸…æ™°åœ°ç¸½çµä»¥ä¸‹æ–‡ä»¶å…§å®¹ï¼š\n\n{truncated_content}"
        summary_response = await chat_llm.ainvoke(prompt) # èª¿ç”¨ ChatOpenAI ç”Ÿæˆæ‘˜è¦
        summary = summary_response.content
        return summary
    except Exception as e:
        logger.error(f"æ–‡ä»¶ {document_id} æ‘˜è¦å¤±æ•— (LLM éŒ¯èª¤): {e}", exc_info=True)
        return "ç„¡æ³•ç”Ÿæˆæ‘˜è¦ã€‚"
2. RAG å›æ‡‰ç”Ÿæˆ - ai-orchestrator/app/services/rag_pipeline.pyæ­¤æœå‹™å¯¦ç¾äº† RAG æµç¨‹ï¼Œçµåˆæª¢ç´¢åˆ°çš„æ–‡ä»¶å…§å®¹å’Œå°è©±æ­·å²ä¾†ç”Ÿæˆæ›´æº–ç¢ºçš„å›æ‡‰ã€‚import os
import logging
from dotenv import load_dotenv
from typing import List, Dict, Any

from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.chains import create_history_aware_retriever, create_retrieval_chain
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain_core.messages import HumanMessage, AIMessage
from langchain_community.vectorstores import Qdrant # LangChain èˆ‡ Qdrant çš„æ•´åˆ
from langchain_community.embeddings import OpenAIEmbeddings # LangChain èˆ‡ OpenAI Embedding æ•´åˆ

# å°å…¥ document_service ä»¥è¨ªå•å…¶å·²åˆå§‹åŒ–çš„ Qdrant å®¢æˆ¶ç«¯å’Œ Embedding æ¨¡å‹
from . import document_service 

logger = logging.getLogger(__name__)

# åˆå§‹åŒ– OpenAI Chat LLM å’Œ Embedding æ¨¡å‹ (ç¢ºä¿ OPENAI_API_KEY å·²è¨­å®š)
chat_llm = None
embeddings_model_for_retriever = None
try:
    openai_api_key = os.getenv("OPENAI_API_KEY")
    if openai_api_key:
        chat_llm = ChatOpenAI(temperature=0.7, openai_api_key=openai_api_key)
        embeddings_model_for_retriever = OpenAIEmbeddings(openai_api_key=openai_api_key)
        logger.info("OpenAI Chat LLM and Embedding models for RAG initialized.")
    else:
        logger.warning("OPENAI_API_KEY æœªè¨­å®šï¼ŒOpenAI æœå‹™å°‡ç„¡æ³•å·¥ä½œã€‚")
except Exception as e:
    logger.error(f"åˆå§‹åŒ– OpenAI æ¨¡å‹å¤±æ•—: {e}. è«‹æª¢æŸ¥ OPENAI_API_KEYã€‚", exc_info=True)


async def get_qdrant_retriever():
    """ç²å– Qdrant å‘é‡å„²å­˜çš„ LangChain Retrieverã€‚"""
    if embeddings_model_for_retriever is None:
        raise RuntimeError("OpenAI Embedding æ¨¡å‹æœªè¼‰å…¥ï¼Œç„¡æ³•åˆå§‹åŒ– Retrieverã€‚")
    
    vector_store = Qdrant(
        client=document_service.client, # é‡ç”¨ document_service ä¸­å·²åˆå§‹åŒ–çš„ Qdrant å®¢æˆ¶ç«¯
        collection_name=document_service.COLLECTION_NAME, # ä½¿ç”¨ document_service ä¸­å®šç¾©çš„é›†åˆåç¨±
        embeddings=embeddings_model_for_retriever, # ä½¿ç”¨ OpenAI Embedding æ¨¡å‹
    )
    return vector_store.as_retriever()


async def generate_response_from_rag(user_id: str, prompt: str, conversation_history: List[Dict[str, str]]) -> str:
    """
    åŸºæ–¼ RAG (Retrieval-Augmented Generation) æµç¨‹ç”Ÿæˆå›æ‡‰ã€‚
    1. æ ¹æ“šç”¨æˆ¶å•é¡Œå’Œæ­·å²å°è©±æª¢ç´¢ç›¸é—œæ–‡ä»¶å¡Šã€‚
    2. å°‡æª¢ç´¢åˆ°çš„å…§å®¹èˆ‡ç”¨æˆ¶å•é¡Œçµåˆï¼Œé€å…¥ LLM ç”Ÿæˆå›ç­”ã€‚
    """
    logger.info(f"ç”¨æˆ¶ {user_id} è«‹æ±‚ RAG å›æ‡‰ï¼Œå•é¡Œ: '{prompt}'")
    
    if chat_llm is None:
        raise RuntimeError("OpenAI Chat LLM æ¨¡å‹æœªè¼‰å…¥ï¼Œç„¡æ³•ç”Ÿæˆ RAG å›æ‡‰ã€‚")

    # å°‡å°è©±æ­·å²è½‰æ›ç‚º LangChain è¨Šæ¯æ ¼å¼ (HumanMessage/AIMessage)
    chat_history_messages = []
    for msg in conversation_history:
        if msg['role'] == 'user':
            chat_history_messages.append(HumanMessage(content=msg['content']))
        elif msg['role'] == 'assistant':
            chat_history_messages.append(AIMessage(content=msg['content']))

    # æ­¥é©Ÿ 1: æ­·å²æ„ŸçŸ¥æª¢ç´¢å™¨
    # å‰µå»ºä¸€å€‹æª¢ç´¢å™¨ï¼Œå®ƒèƒ½å¤ æ ¹æ“šç•¶å‰å°è©±æ­·å²å’Œç”¨æˆ¶è¼¸å…¥ç”Ÿæˆæ›´ç²¾ç¢ºçš„æª¢ç´¢æŸ¥è©¢ã€‚
    retriever = await get_qdrant_retriever()
    history_aware_retriever = create_history_aware_retriever(
        chat_llm, 
        retriever, 
        ChatPromptTemplate.from_messages([
            MessagesPlaceholder("chat_history"), # åŒ…å«å°è©±æ­·å²
            ("user", "{input}"), # ç•¶å‰ç”¨æˆ¶è¼¸å…¥
            ("user", "æ ¹æ“šä»¥ä¸Šå°è©±å’Œæˆ‘çš„å•é¡Œï¼Œè«‹ç¸½çµå‡ºä¸€å€‹ç¨ç«‹çš„å•é¡Œï¼Œä»¥ä¾¿å¾æ–‡ä»¶ä¸­æª¢ç´¢ç›¸é—œä¿¡æ¯ã€‚") # æç¤º LLM ç”Ÿæˆæ–°çš„æª¢ç´¢å•é¡Œ
        ])
    )

    # æ­¥é©Ÿ 2: æ–‡ä»¶çµ„åˆéˆ
    # å°‡æª¢ç´¢åˆ°çš„æ–‡ä»¶å…§å®¹ä½œç‚ºä¸Šä¸‹æ–‡ï¼Œçµåˆç”¨æˆ¶å•é¡Œï¼Œé€å…¥ LLM ç”Ÿæˆå›ç­”ã€‚
    document_chain = create_stuff_documents_chain(
        chat_llm, 
        ChatPromptTemplate.from_messages([
            ("system", "æ‚¨æ˜¯ä¸€å€‹æ™ºæ…§åŠ©æ‰‹ï¼Œè«‹æ ¹æ“šæä¾›çš„ä¸Šä¸‹æ–‡å’Œå°è©±æ­·å²ï¼Œç°¡æ½”ã€å°ˆæ¥­åœ°å›ç­”ç”¨æˆ¶çš„å•é¡Œã€‚\n\nä¸Šä¸‹æ–‡:\n{context}"), # ç³»çµ±æç¤ºï¼Œæä¾›ä¸Šä¸‹æ–‡
            MessagesPlaceholder("chat_history"),
            ("user", "{input}"),
        ])
    )

    # æ­¥é©Ÿ 3: RAG éˆ
    # çµåˆæ­·å²æ„ŸçŸ¥æª¢ç´¢å™¨å’Œæ–‡ä»¶çµ„åˆéˆï¼Œå½¢æˆå®Œæ•´çš„ RAG æµç¨‹ã€‚
    retrieval_chain = create_retrieval_chain(history_aware_retriever, document_chain)
    
    try:
        # èª¿ç”¨ RAG éˆï¼Œå‚³å…¥å°è©±æ­·å²å’Œç•¶å‰ç”¨æˆ¶è¼¸å…¥
        response = await retrieval_chain.ainvoke({
            "chat_history": chat_history_messages,
            "input": prompt
        })
        response_text = response["answer"] # ç²å– LLM ç”Ÿæˆçš„å›ç­”
        logger.info(f"RAG å›æ‡‰ç”Ÿæˆå®Œæˆï¼Œå›æ‡‰: '{response_text[:50]}...'")
        return response_text
    except Exception as e:
        logger.error(f"RAG å›æ‡‰ç”Ÿæˆå¤±æ•— (LLM æˆ–æª¢ç´¢éŒ¯èª¤): {e}", exc_info=True)
        return "å¾ˆæŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•ç”ŸæˆåŸºæ–¼å…§éƒ¨è³‡æ–™çš„å›æ‡‰ã€‚è«‹å˜—è©¦æ›å€‹å•é¡Œæˆ–ç¨å¾Œå†è©¦ã€‚"
3. èªéŸ³è½‰éŒ„ - ai-orchestrator/app/main.pyé€™æ˜¯ FastAPI æ‡‰ç”¨ç¨‹åºçš„å…¥å£æ–‡ä»¶ï¼ŒåŒ…å«èªéŸ³è½‰éŒ„ APIã€‚import io
import os
import logging
from fastapi import FastAPI, UploadFile, File, HTTPException
from pydantic import BaseModel
from typing import List, Dict, Any

from faster_whisper import WhisperModel # å°å…¥ Faster-Whisper æ¨¡å‹

# å°å…¥å…¶ä»–æœå‹™å’Œæ¨¡å‹
from .services.document_service import process_document_embedding, search_documents_qdrant, summarize_document
from .services.rag_pipeline import generate_response_from_rag
from .models.document_models import DocumentUploadRequest, DocumentSearchResponse, DocumentSummaryResponse
from .models.voice_models import VoiceTranscriptionResponse, VoiceResponseRequest, VoiceResponse

logger = logging.getLogger(__name__)

app = FastAPI(title="AI Orchestrator Microservice")

# å…¨å±€è¼‰å…¥ Whisper æ¨¡å‹ï¼Œç¢ºä¿åªè¼‰å…¥ä¸€æ¬¡
WHISPER_MODEL_NAME = os.getenv("WHISPER_MODEL", "tiny")
WHISPER_DEVICE = os.getenv("WHISPER_DEVICE", "cpu") # é‹è¡Œè¨­å‚™ï¼š'cpu' æˆ– 'cuda'
WHISPER_COMPUTE_TYPE = os.getenv("WHISPER_COMPUTE_TYPE", "int8") # è¨ˆç®—é¡å‹ï¼š'int8' (CPU å„ªåŒ–) æˆ– 'float16' (GPU å„ªåŒ–)
WHISPER_DOWNLOAD_ROOT = "./data/whisper_models" # æ¨¡å‹ä¸‹è¼‰å’Œå„²å­˜è·¯å¾‘

whisper_model = None
try:
    logger.info(f"å˜—è©¦è¼‰å…¥ Faster-Whisper æ¨¡å‹: {WHISPER_MODEL_NAME} (Device: {WHISPER_DEVICE}, Compute Type: {WHISPER_COMPUTE_TYPE})")
    whisper_model = WhisperModel(
        WHISPER_MODEL_NAME,
        device=WHISPER_DEVICE,
        compute_type=WHISPER_COMPUTE_TYPE,
        download_root=WHISPER_DOWNLOAD_ROOT # æŒ‡å®šæ¨¡å‹å„²å­˜è·¯å¾‘
    )
    logger.info(f"Faster-Whisper model '{WHISPER_MODEL_NAME}' loaded successfully.")
except Exception as e:
    logger.error(f"è¼‰å…¥ Faster-Whisper æ¨¡å‹å¤±æ•—: {e}", exc_info=True)


@app.post("/voice/transcribe", response_model=VoiceTranscriptionResponse)
async def transcribe_voice(audio_file: UploadFile = File(...)):
    """
    æ¥æ”¶èªéŸ³æª” (ä¾‹å¦‚ webm æ ¼å¼)ï¼Œä½¿ç”¨ Faster-Whisper é€²è¡Œè½‰éŒ„ã€‚
    """
    logger.info(f"æ”¶åˆ°èªéŸ³è½‰éŒ„è«‹æ±‚: filename='{audio_file.filename}', content_type='{audio_file.content_type}'")

    if whisper_model is None:
        raise HTTPException(status_code=503, detail="èªéŸ³è½‰éŒ„æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œæ¨¡å‹è¼‰å…¥å¤±æ•—ã€‚")

    # æª¢æŸ¥éŸ³é »æ ¼å¼æ˜¯å¦æ”¯æ´
    if audio_file.content_type not in ["audio/webm", "audio/mp3", "audio/wav", "audio/ogg"]:
         logger.warning(f"ä¸æ”¯æ´çš„éŸ³é »æ ¼å¼: {audio_file.content_type}")
         raise HTTPException(status_code=400, detail=f"éŸ³é »æ ¼å¼ {audio_file.content_type} ä¸æ”¯æ´ã€‚")

    try:
        # å°‡ä¸Šå‚³çš„éŸ³é »æ–‡ä»¶è®€å…¥å…§å­˜ä¸­çš„ BytesIO æµ
        audio_bytes = await audio_file.read()
        audio_stream = io.BytesIO(audio_bytes)

        # ä½¿ç”¨ Faster-Whisper é€²è¡ŒèªéŸ³è½‰éŒ„
        segments, info = whisper_model.transcribe(audio_stream, beam_size=5) # beam_size æ˜¯ä¸€å€‹è½‰éŒ„åƒæ•¸
        
        transcribed_text = ""
        for segment in segments:
            transcribed_text += segment.text + " " # æ‹¼æ¥æ‰€æœ‰è½‰éŒ„ç‰‡æ®µ
        
        transcribed_text = transcribed_text.strip() # ç§»é™¤é¦–å°¾ç©ºæ ¼
        
        logger.info(f"èªéŸ³è½‰éŒ„å®Œæˆ: '{transcribed_text[:50]}...'")
        return VoiceTranscriptionResponse(transcribed_text=transcribed_text)
    except Exception as e:
        logger.error(f"èªéŸ³è½‰éŒ„å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"èªéŸ³è½‰éŒ„å¤±æ•—: {e}")

# ... (å…¶ä»–æ–‡ä»¶å’ŒèªéŸ³ç›¸é—œçš„ API è·¯ç”±ä¹Ÿåœ¨æ­¤æ–‡ä»¶ä¸­å®šç¾©)
C. å‰ç«¯æœå‹™ (Vue3)å‰ç«¯æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ Vue3 å’Œ Pinia æ§‹å»ºï¼Œæä¾›ç›´è§€çš„ç”¨æˆ¶ç•Œé¢ã€‚1. èªè­‰ç‹€æ…‹ç®¡ç† - frontend/src/stores/auth.jsä½¿ç”¨ Pinia ç®¡ç†ç”¨æˆ¶èªè­‰ç‹€æ…‹å’Œ API Tokenã€‚import { defineStore } from 'pinia';
import axios from 'axios'; // ä½¿ç”¨ axios é€²è¡Œ HTTP è«‹æ±‚

// å¾ Vite ç’°å¢ƒè®Šæ•¸ç²å–å¾Œç«¯ API URL
const API_URL = import.meta.env.VITE_API_URL;

export const useAuthStore = defineStore('auth', {
  state: () => ({
    authToken: localStorage.getItem('authToken') || null, // å¾ localStorage ç²å– token
    user: JSON.parse(localStorage.getItem('user')) || null, // å¾ localStorage ç²å–ç”¨æˆ¶ä¿¡æ¯
    loading: false, // æ¨™ç¤ºåŠ è¼‰ç‹€æ…‹
    error: null,    // æ¨™ç¤ºéŒ¯èª¤ä¿¡æ¯
  }),
  getters: {
    // åˆ¤æ–·ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
    isLoggedIn: (state) => !!state.authToken, 
    // ç²å–ç•¶å‰ç”¨æˆ¶
    currentUser: (state) => state.user,
  },
  actions: {
    // è¨­ç½® HTTP è«‹æ±‚é ­ä¸­çš„èªè­‰ Token
    setAuthHeader(token) {
      if (token) {
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      } else {
        delete axios.defaults.headers.common['Authorization'];
      }
    },

    // ç”¨æˆ¶ç™»å…¥æ–¹æ³•
    async login(credentials) {
      this.loading = true;
      this.error = null;
      try {
        const response = await axios.post(`${API_URL}/login`, credentials, {
            // ç¢ºä¿è·¨åŸŸè«‹æ±‚æ”œå¸¶æ†‘è­‰ï¼ˆcookie/tokenï¼‰
            withCredentials: true 
        });
        const { token, user } = response.data;
        this.authToken = token;
        this.user = user;
        localStorage.setItem('authToken', token); // å°‡ token å„²å­˜åˆ° localStorage
        localStorage.setItem('user', JSON.stringify(user)); // å°‡ç”¨æˆ¶ä¿¡æ¯å„²å­˜åˆ° localStorage
        this.setAuthHeader(token); // è¨­ç½®å…¨å±€ axios è«‹æ±‚é ­
        this.loading = false;
        return true;
      } catch (error) {
        this.error = error.response?.data?.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ†‘è­‰ã€‚';
        this.loading = false;
        return false;
      }
    },

    // ç”¨æˆ¶è¨»å†Šæ–¹æ³•
    async register(userData) {
      this.loading = true;
      this.error = null;
      try {
        const response = await axios.post(`${API_URL}/register`, userData, {
             withCredentials: true
        });
        const { token, user } = response.data;
        this.authToken = token;
        this.user = user;
        localStorage.setItem('authToken', token);
        localStorage.setItem('user', JSON.stringify(user));
        this.setAuthHeader(token);
        this.loading = false;
        return true;
      } catch (error) {
        this.error = error.response?.data?.errors ? Object.values(error.response.data.errors).flat().join(', ') : 'è¨»å†Šå¤±æ•—ã€‚';
        this.loading = false;
        return false;
      }
    },

    // ç”¨æˆ¶ç™»å‡ºæ–¹æ³•
    async logout() {
      this.loading = true;
      try {
        await axios.post(`${API_URL}/logout`, {}, {
             withCredentials: true
        });
        this.authToken = null; // æ¸…é™¤ token
        this.user = null;     // æ¸…é™¤ç”¨æˆ¶ä¿¡æ¯
        localStorage.removeItem('authToken'); // å¾ localStorage ç§»é™¤ token
        localStorage.removeItem('user');     // å¾ localStorage ç§»é™¤ç”¨æˆ¶ä¿¡æ¯
        this.setAuthHeader(null); // ç§»é™¤ axios è«‹æ±‚é ­
        this.loading = false;
        return true;
      } catch (error) {
        this.error = error.response?.data?.message || 'ç™»å‡ºå¤±æ•—ã€‚';
        this.loading = false;
        return false;
      }
    },

    // åˆå§‹åŒ–èªè­‰ç‹€æ…‹ (åœ¨æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚èª¿ç”¨)
    initialize() {
      if (this.authToken) {
        this.setAuthHeader(this.authToken);
        // å¯é¸ï¼šé©—è­‰ token æ˜¯å¦æœ‰æ•ˆï¼Œä¾‹å¦‚èª¿ç”¨ /api/user ç²å–ç”¨æˆ¶ä¿¡æ¯
        // this.fetchUser(); 
      }
    },

    // ç²å–èªè­‰ç”¨æˆ¶ä¿¡æ¯
    async fetchUser() {
      if (!this.isLoggedIn) return null;
      try {
        const response = await axios.get(`${API_URL}/user`, {
            withCredentials: true
        });
        this.user = response.data;
        localStorage.setItem('user', JSON.stringify(this.user));
        return this.user;
      } catch (error) {
        console.error('ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
        this.logout(); // å¦‚æœ token ç„¡æ•ˆï¼Œå‰‡ç™»å‡º
        return null;
      }
    }
  },
});

2. æ–‡ä»¶ä¸Šå‚³çµ„ä»¶æ ¸å¿ƒé‚è¼¯ - frontend/src/views/DocumentsView.vueæ­¤çµ„ä»¶å…è¨±ç”¨æˆ¶ä¸Šå‚³æ–‡ä»¶ä¸¦é¡¯ç¤ºè™•ç†ç‹€æ…‹å’Œæœå°‹çµæœã€‚<template>
  <div class="max-w-4xl mx-auto p-4 bg-white shadow-lg rounded-lg">
    <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">æ–‡ä»¶æ™ºæ…§ç®¡ç†ç³»çµ±</h1>

    <!-- æ–‡ä»¶ä¸Šå‚³å€å¡Š -->
    <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">ä¸Šå‚³æ–°æ–‡ä»¶</h2>
      <form @submit.prevent="uploadDocument" class="space-y-4">
        <div>
          <label for="file-upload" class="block text-sm font-medium text-gray-700">é¸æ“‡æ–‡ä»¶ (PDF, DOCX, TXT)</label>
          <input 
            type="file" 
            id="file-upload" 
            @change="handleFileUpload" 
            class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
            accept=".pdf,.doc,.docx,.txt"
          />
          <p v-if="selectedFile" class="mt-2 text-sm text-gray-600">å·²é¸æ“‡æ–‡ä»¶: {{ selectedFile.name }}</p>
        </div>
        <div>
          <label for="category" class="block text-sm font-medium text-gray-700">æ–‡ä»¶åˆ†é¡ (å¯é¸)</label>
          <input 
            type="text" 
            id="category" 
            v-model="documentCategory" 
            placeholder="ä¾‹å¦‚ï¼šå ±å‘Š, åˆåŒ, æ”¿ç­–"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          />
        </div>
        <button 
          type="submit" 
          :disabled="!selectedFile || uploadLoading"
          class="w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ uploadLoading ? 'ä¸Šå‚³ä¸­...' : 'é–‹å§‹ä¸Šå‚³' }}
        </button>
      </form>
      <p v-if="uploadMessage" :class="uploadError ? 'text-red-600' : 'text-green-600'" class="mt-4 text-center">
        {{ uploadMessage }}
      </p>
    </div>

    <!-- æ–‡ä»¶æœå°‹å€å¡Š -->
    <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">æœå°‹æ–‡ä»¶</h2>
      <form @submit.prevent="searchDocuments" class="flex space-x-2">
        <input 
          type="text" 
          v-model="searchQuery" 
          placeholder="è¼¸å…¥æ‚¨æƒ³æœå°‹çš„å…§å®¹..."
          class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        />
        <button 
          type="submit" 
          :disabled="!searchQuery.trim() || searchLoading"
          class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ searchLoading ? 'æœå°‹ä¸­...' : 'æœå°‹' }}
        </button>
      </form>
      <div v-if="searchResults.length > 0" class="mt-6">
        <h4 class="text-xl font-semibold text-gray-700 mb-3">æœå°‹çµæœ:</h4>
        <ul class="space-y-3">
          <li v-for="result in searchResults" :key="result.document_id + '-' + result.score" class="p-4 border border-gray-200 rounded-md bg-gray-50">
            <p class="text-sm text-gray-500">ç›¸é—œæ€§åˆ†æ•¸: {{ (result.score * 100).toFixed(2) }}%</p>
            <p class="font-medium text-indigo-700">æ–‡ä»¶ ID: {{ result.document_id }}</p>
            <p class="text-gray-800 break-words">{{ result.text_chunk }}</p>
            <p v-if="result.metadata && Object.keys(result.metadata).length > 0" class="text-xs text-gray-500 mt-1">
              å…ƒæ•¸æ“š: {{ JSON.stringify(result.metadata) }}
            </p>
          </li>
        </ul>
      </div>
      <p v-else-if="searchLoading === false && searchedOnce" class="mt-4 text-center text-gray-600">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„çµæœã€‚</p>
      <p v-if="searchError" class="mt-4 text-center text-red-600">
        æœå°‹å¤±æ•—: {{ searchError }}
      </p>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import axios from 'axios';
import { useAuthStore } from '../stores/auth'; // å°å…¥èªè­‰ç‹€æ…‹ç®¡ç†

const authStore = useAuthStore(); // ç²å–èªè­‰ Store å¯¦ä¾‹

const API_URL = import.meta.env.VITE_API_URL; // å¾ç’°å¢ƒè®Šæ•¸ç²å– API URL

// æ–‡ä»¶ä¸Šå‚³ç›¸é—œç‹€æ…‹
const selectedFile = ref(null);
const documentCategory = ref('');
const uploadLoading = ref(false);
const uploadMessage = ref('');
const uploadError = ref(false);

// æ–‡ä»¶æœå°‹ç›¸é—œç‹€æ…‹
const searchQuery = ref('');
const searchLoading = ref(false);
const searchResults = ref([]);
const searchError = ref(null);
const searchedOnce = ref(false); // æ¨™è¨˜æ˜¯å¦å·²é€²è¡Œéæœå°‹

// è™•ç†æ–‡ä»¶é¸æ“‡äº‹ä»¶
const handleFileUpload = (event) => {
  selectedFile.value = event.target.files[0];
  uploadMessage.value = ''; // æ¸…é™¤ä¹‹å‰çš„ä¸Šå‚³è¨Šæ¯
  uploadError.value = false;
};

// ä¸Šå‚³æ–‡ä»¶é‚è¼¯
const uploadDocument = async () => {
  if (!selectedFile.value) {
    uploadError.value = true;
    uploadMessage.value = 'è«‹é¸æ“‡ä¸€å€‹æ–‡ä»¶ã€‚';
    return;
  }

  uploadLoading.value = true;
  uploadMessage.value = '';
  uploadError.value = false;

  const formData = new FormData();
  formData.append('file', selectedFile.value); // æ·»åŠ æ–‡ä»¶
  formData.append('category', documentCategory.value); // æ·»åŠ åˆ†é¡

  try {
    const response = await axios.post(`${API_URL}/documents/upload`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data', // è¨­ç½®æ­£ç¢ºçš„ Content-Type
      },
      withCredentials: true, // ç¢ºä¿æ”œå¸¶è·¨åŸŸæ†‘è­‰
    });
    uploadMessage.value = 'æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼AI æ­£åœ¨è™•ç†ä¸­ã€‚';
    selectedFile.value = null; // æ¸…ç©ºé¸æ“‡
    documentCategory.value = ''; // æ¸…ç©ºåˆ†é¡
    if (document.getElementById('file-upload')) {
        document.getElementById('file-upload').value = ''; // æ¸…ç©ºæ–‡ä»¶è¼¸å…¥æ¡†
    }
  } catch (error) {
    console.error('æ–‡ä»¶ä¸Šå‚³å¤±æ•—:', error);
    uploadError.value = true;
    uploadMessage.value = error.response?.data?.message || 'æ–‡ä»¶ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
    if (error.response && error.response.data && error.response.data.errors) {
        // é¡¯ç¤ºå¾Œç«¯é©—è­‰éŒ¯èª¤
        uploadMessage.value += ' ' + Object.values(error.response.data.errors).flat().join(' ');
    }
  } finally {
    uploadLoading.value = false;
  }
};

// æœå°‹æ–‡ä»¶é‚è¼¯
const searchDocuments = async () => {
  if (!searchQuery.value.trim()) {
    searchError.value = 'è«‹è¼¸å…¥æœå°‹å…§å®¹ã€‚';
    return;
  }

  searchLoading.value = true;
  searchError.value = null;
  searchResults.value = [];
  searchedOnce.value = true;

  try {
    const response = await axios.get(`${API_URL}/documents/search`, {
      params: { q: searchQuery.value }, // æœå°‹åƒæ•¸
      withCredentials: true,
    });
    searchResults.value = response.data.results;
  } catch (error) {
    console.error('æ–‡ä»¶æœå°‹å¤±æ•—:', error);
    searchError.value = error.response?.data?.message || 'æ–‡ä»¶æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
  } finally {
    searchLoading.value = false;
  }
};
</script>

<style scoped>
/* Tailwind CSS æœƒè‡ªå‹•è™•ç†å¤§éƒ¨åˆ†æ¨£å¼ï¼Œé€™è£¡åªä¿ç•™äº†å°‘é‡çš„ scoped æ¨£å¼ */
/* å¯ä»¥æ ¹æ“šéœ€è¦æ·»åŠ æ›´å¤šè‡ªå®šç¾©æ¨£å¼ */
</style>
3. èªéŸ³éŒ„è£½èˆ‡äº’å‹•çµ„ä»¶æ ¸å¿ƒé‚è¼¯ - frontend/src/views/VoiceAssistantView.vueæ­¤çµ„ä»¶è² è²¬è™•ç†éº¥å…‹é¢¨è¼¸å…¥ã€èªéŸ³éŒ„è£½ï¼Œä¸¦å°‡éŸ³é »æ•¸æ“šç™¼é€åˆ°å¾Œç«¯é€²è¡Œè½‰éŒ„å’Œ AI å›æ‡‰ã€‚<template>
  <div class="max-w-xl mx-auto p-4 bg-white shadow-lg rounded-lg">
    <h1 class="text-3xl font-bold text-center text-green-700 mb-6">AI èªéŸ³åŠ©ç†</h1>

    <div class="flex flex-col items-center space-y-4">
      <!-- éŒ„éŸ³æŒ‰éˆ• -->
      <button
        @click="toggleRecording"
        :class="{
          'bg-red-600 hover:bg-red-700': isRecording,
          'bg-green-600 hover:bg-green-700': !isRecording,
        }"
        :disabled="processing"
        class="w-32 h-32 rounded-full text-white flex items-center justify-center shadow-lg transform transition-all duration-200 ease-in-out"
        :aria-label="isRecording ? 'åœæ­¢éŒ„éŸ³' : 'é–‹å§‹éŒ„éŸ³'"
      >
        <svg v-if="!isRecording" class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v6a3 3 0 003 3h6a3 3 0 003-3V7a3 3 0 00-3-3H7zM4 7a4 4 0 014-4h4a4 4 0 014 4v6a4 4 0 01-4 4H8a4 4 0 01-4-4V7zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
          <path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v6a3 3 0 003 3h6a3 3 0 003-3V7a3 3 0 00-3-3H7z" clip-rule="evenodd" />
          <circle cx="10" cy="10" r="3" fill="white"/>
        </svg>
        <svg v-else class="w-16 h-16 animate-pulse" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v6a3 3 0 003 3h6a3 3 0 003-3V7a3 3 0 00-3-3H7z" clip-rule="evenodd" />
        </svg>
      </button>

      <!-- ç‹€æ…‹è¨Šæ¯ -->
      <p v-if="processing" class="text-indigo-600 font-semibold text-lg">AI æ€è€ƒä¸­...</p>
      <p v-else-if="isRecording" class="text-red-500 font-semibold text-lg">éŒ„éŸ³ä¸­...</p>
      <p v-else class="text-gray-600 text-lg">é»æ“Šéº¥å…‹é¢¨é–‹å§‹éŒ„éŸ³</p>

      <!-- éŒ¯èª¤è¨Šæ¯ -->
      <p v-if="error" class="text-red-500 text-center mt-2">{{ error }}</p>
    </div>

    <!-- å°è©±æ­·å² -->
    <div class="mt-8 p-6 border border-gray-200 rounded-lg shadow-sm max-h-96 overflow-y-auto">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">å°è©±æ­·å²:</h2>
      <div v-if="conversationHistory.length === 0" class="text-center text-gray-500">
        ç›®å‰æ²’æœ‰å°è©±ã€‚
      </div>
      <div v-for="(message, index) in conversationHistory" :key="index" class="mb-3">
        <div v-if="message.speaker === 'user'" class="text-right">
          <span class="inline-block bg-blue-100 text-blue-800 rounded-lg px-4 py-2 max-w-xs break-words">
            ä½ : {{ message.text }}
          </span>
        </div>
        <div v-else class="text-left">
          <span class="inline-block bg-green-100 text-green-800 rounded-lg px-4 py-2 max-w-xs break-words">
            AI åŠ©æ‰‹: {{ message.text }}
          </span>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';
import axios from 'axios';
import { useAuthStore } from '../stores/auth'; // å°å…¥èªè­‰ç‹€æ…‹ç®¡ç†

const authStore = useAuthStore();
const API_URL = import.meta.env.VITE_API_URL;

const isRecording = ref(false); // æ˜¯å¦æ­£åœ¨éŒ„éŸ³
const processing = ref(false);  // æ˜¯å¦æ­£åœ¨è™•ç†èªéŸ³ (AI æ€è€ƒä¸­)
const mediaRecorder = ref(null); // MediaRecorder å¯¦ä¾‹
const audioChunks = ref([]);     // å„²å­˜éŒ„éŸ³æ•¸æ“šå¡Š
const error = ref(null);         // éŒ¯èª¤ä¿¡æ¯

// å°è©±æ­·å²ï¼ŒåŒ…å«ç™¼è¨€è€…å’Œå…§å®¹
const conversationHistory = ref([]); 

// ç²å–ç•¶å‰ç”¨æˆ¶ IDï¼Œç”¨æ–¼æ¨™è­˜å°è©±
const currentUserId = ref(localStorage.getItem('userId') || 'guest_user'); // é€™è£¡ç°¡å–®å¾ localStorage å–ï¼Œå¯¦éš›æ‡‰å¾èªè­‰ Store ç²å–

// é é¢åŠ è¼‰æ™‚ç²å–æ­·å²å°è©±
onMounted(async () => {
  await fetchConversationHistory();
});

// é é¢å¸è¼‰æ™‚åœæ­¢éŒ„éŸ³ï¼ˆå¦‚æœæ­£åœ¨éŒ„éŸ³ï¼‰
onUnmounted(() => {
  if (isRecording.value && mediaRecorder.value) {
    mediaRecorder.value.stop();
    isRecording.value = false;
  }
});

// ç²å–å°è©±æ­·å²
const fetchConversationHistory = async () => {
    try {
        const response = await axios.get(`${API_URL}/voice/history/${currentUserId.value}`, {
            withCredentials: true,
        });
        // å°‡å¾Œç«¯è¿”å›çš„ {speaker, text, created_at} æ ¼å¼è½‰æ›ç‚º {speaker, text}
        conversationHistory.value = response.data.map(msg => ({
            speaker: msg.speaker,
            text: msg.text
        }));
    } catch (err) {
        console.error('ç²å–å°è©±æ­·å²å¤±æ•—:', err);
        error.value = 'ç„¡æ³•ç²å–å°è©±æ­·å²ã€‚';
    }
};

// åˆ‡æ›éŒ„éŸ³ç‹€æ…‹ (é–‹å§‹/åœæ­¢)
const toggleRecording = async () => {
  if (processing.value) return; // æ­£åœ¨è™•ç†æ™‚ä¸å…è¨±æ“ä½œ

  if (!isRecording.value) {
    // é–‹å§‹éŒ„éŸ³
    error.value = null; // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
    audioChunks.value = []; // æ¸…ç©ºä¹‹å‰çš„éŸ³é »æ•¸æ“š

    try {
      // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      // å‰µå»º MediaRecorder å¯¦ä¾‹ï¼ŒæŒ‡å®šè¼¸å‡ºæ ¼å¼ç‚º audio/webm
      mediaRecorder.value = new MediaRecorder(stream, { mimeType: 'audio/webm' });

      // ç›£è½æ•¸æ“šå¯ç”¨äº‹ä»¶
      mediaRecorder.value.ondataavailable = (event) => {
        audioChunks.value.push(event.data);
      };

      // ç›£è½åœæ­¢éŒ„éŸ³äº‹ä»¶
      mediaRecorder.value.onstop = async () => {
        processing.value = true; // é€²å…¥è™•ç†ä¸­ç‹€æ…‹
        isRecording.value = false; // éŒ„éŸ³ç‹€æ…‹çµæŸ
        // å°‡æ‰€æœ‰éŸ³é »æ•¸æ“šå¡Šçµ„åˆæˆä¸€å€‹ Blob
        const audioBlob = new Blob(audioChunks.value, { type: 'audio/webm' });
        
        // å°‡ Blob ç™¼é€åˆ°å¾Œç«¯é€²è¡Œè™•ç†
        await sendAudioToBackend(audioBlob);

        // åœæ­¢éº¥å…‹é¢¨æµ
        stream.getTracks().forEach(track => track.stop());
        processing.value = false; // è™•ç†çµæŸ
      };

      mediaRecorder.value.start(); // é–‹å§‹éŒ„éŸ³
      isRecording.value = true;
      console.log('éŒ„éŸ³é–‹å§‹...');

    } catch (err) {
      console.error('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨:', err);
      error.value = 'ç„¡æ³•ç²å–éº¥å…‹é¢¨æ¬Šé™æˆ–é–‹å§‹éŒ„éŸ³ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚';
    }
  } else {
    // åœæ­¢éŒ„éŸ³
    if (mediaRecorder.value && mediaRecorder.value.state === 'recording') {
      mediaRecorder.value.stop();
      console.log('éŒ„éŸ³åœæ­¢...');
    }
  }
};

// å°‡éŸ³é » Blob ç™¼é€åˆ°å¾Œç«¯ API
const sendAudioToBackend = async (audioBlob) => {
  const formData = new FormData();
  // å°‡éŸ³é » Blob å‘½åç‚º 'audio'ï¼Œå¾Œç«¯å°‡ä»¥æ­¤åç¨±æ¥æ”¶æ–‡ä»¶
  formData.append('audio', audioBlob, 'audio.webm'); 
  formData.append('user_id', currentUserId.value); // å‚³éç”¨æˆ¶ ID

  try {
    const response = await axios.post(`${API_URL}/voice/process`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data', // è¨­ç½®æ­£ç¢ºçš„ Content-Type
      },
      withCredentials: true,
    });

    const { transcribed_text, response_text } = response.data;
    // å°‡è½‰éŒ„æ–‡æœ¬å’Œ AI å›æ‡‰æ·»åŠ åˆ°å°è©±æ­·å²ä¸­
    conversationHistory.value.push({ speaker: 'user', text: transcribed_text });
    conversationHistory.value.push({ speaker: 'assistant', text: response_text });
    error.value = null; // æ¸…é™¤ä»»ä½•éŒ¯èª¤

  } catch (err) {
    console.error('ç™¼é€éŸ³é »åˆ°å¾Œç«¯å¤±æ•—:', err);
    error.value = err.response?.data?.message || 'è™•ç†èªéŸ³è¼¸å…¥å¤±æ•—ã€‚';
  }
};
</script>

<style scoped>
/* Tailwind CSS è™•ç†å¤§éƒ¨åˆ†æ¨£å¼ã€‚é€™è£¡å¯ä»¥æ·»åŠ è‡ªå®šç¾©éæ¸¡æ•ˆæœæˆ–å‹•ç•«ã€‚ */
button {
  transition: all 0.2s ease-in-out;
}
button:hover {
  transform: scale(1.05);
}
button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
</style>
âš¡ å¿«é€Ÿå•Ÿå‹• (Quick Start)è«‹ç¢ºä¿æ‚¨çš„ç³»çµ±å·²å®‰è£ Docker å’Œ Docker Composeã€‚é€²å…¥å°ˆæ¡ˆç›®éŒ„ï¼šcd workflow-ai-platform
é…ç½®ç’°å¢ƒè®Šæ•¸ï¼šè¤‡è£½ .env.example ç‚º .envï¼Œç„¶å¾Œæ‰“é–‹ .env æª”æ¡ˆï¼Œå‹™å¿…å¡«å¯«æ‚¨çš„ OPENAI_API_KEYã€‚cp .env.example .env
# æ‰“é–‹ .env æª”æ¡ˆä¸¦å¡«å¯« OPENAI_API_KEY
æ§‹å»ºä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™ï¼šé€™æœƒä¸‹è¼‰æ‰€æœ‰å¿…è¦çš„ Docker æ˜ åƒä¸¦å•Ÿå‹• Laravel å¾Œç«¯ã€Vue å‰ç«¯ã€FastAPI AI å¾®æœå‹™ã€MySQL è³‡æ–™åº«å’Œ Qdrant å‘é‡è³‡æ–™åº«ã€‚docker compose build
docker compose up -d
Laravel å¾Œç«¯åˆå§‹åŒ– (é‡è¦)ï¼šé€²å…¥ backend å®¹å™¨ä¸¦åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ä¾†åˆå§‹åŒ– Laravel æ‡‰ç”¨ç¨‹å¼ï¼šdocker exec -it workflow-ai-backend bash
php artisan key:generate           # ç”Ÿæˆæ‡‰ç”¨ç¨‹å¼åŠ å¯†é‡‘é‘°
php artisan migrate                # åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼Œå‰µå»º documents å’Œ voices è¡¨
php artisan db:seed                # å¯é¸ï¼šå¡«å……å‡æ•¸æ“šï¼ŒåŒ…æ‹¬ç”¨æˆ¶ã€æ–‡ä»¶å’ŒèªéŸ³è¨˜éŒ„
php artisan scribe:generate        # ç”Ÿæˆ API æ–‡æª”
exit                               # é€€å‡ºå®¹å™¨
Caddy åå‘ä»£ç† (å¯é¸)ï¼šå¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨ Caddy ä½œç‚ºçµ±ä¸€å…¥å£ï¼Œè«‹å…ˆåœ¨æ‚¨çš„ä¸»æ©Ÿä¸Šå®‰è£ Caddy (åƒè€ƒ Caddy å®˜æ–¹æ–‡æª”)ï¼Œç„¶å¾Œåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼šcaddy run --config Caddyfile
ä¹‹å¾Œå¯é€éä»¥ä¸‹åœ°å€è¨ªå•ï¼šFrontend: http://localhost:8081Backend: http://localhost:8080AI Orchestrator: http://localhost:8082ğŸŒ è¨ªå•æ‡‰ç”¨ç¨‹å¼èˆ‡ API æ–‡æª”å‰ç«¯æ‡‰ç”¨: http://localhost:5173 (æˆ–é€šé Caddy çš„ http://localhost:8081)å¾Œç«¯ Laravel API: http://localhost:8000/api (æˆ–é€šé Caddy çš„ http://localhost:8080/api)AI å¾®æœå‹™ API (FastAPI) æ–‡æª” (Swagger UI): http://localhost:8001/docs (æˆ–é€šé Caddy çš„ http://localhost:8082/docs)å¾Œç«¯ Laravel API æ–‡æª” (Scribe): http://localhost:8000/docs (æˆ–é€šé Caddy çš„ http://localhost:8080/docs)âœ… é‹è¡Œæ¸¬è©¦ (Running Tests)å‰ç«¯å–®å…ƒæ¸¬è©¦ (Vitest)é€²å…¥å‰ç«¯ç›®éŒ„ï¼šcd frontend
é‹è¡Œæ¸¬è©¦ï¼šnpm test
# æˆ– npm run test:watch ç›£è½æ–‡ä»¶è®ŠåŒ–
å®Œæˆå¾Œè¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼šcd ..
å‰ç«¯ç«¯åˆ°ç«¯æ¸¬è©¦ (Cypress E2E)ç¢ºä¿æ‰€æœ‰ Docker æœå‹™éƒ½åœ¨é‹è¡Œä¸­ã€‚ç‚ºæ–‡ä»¶ä¸Šå‚³æ¸¬è©¦æº–å‚™å‡æ–‡ä»¶ï¼šCypress çš„æ–‡ä»¶ä¸Šå‚³æ¸¬è©¦éœ€è¦ä¸€å€‹å¯¦éš›çš„ PDF æ–‡ä»¶ã€‚è«‹åœ¨ frontend/cypress/fixtures/ ç›®éŒ„ä¸‹æ‰‹å‹•å‰µå»ºä¸€å€‹åç‚º test_pdf.pdf çš„ä»»æ„ PDF æ–‡ä»¶ï¼ˆå¯ä»¥æ˜¯ä¸€å€‹ç©ºç™½ PDFï¼Œç”¨æ–¼æ¨¡æ“¬ä¸Šå‚³ï¼‰ã€‚é€²å…¥å‰ç«¯ç›®éŒ„ï¼šcd frontend
æ‰“é–‹ Cypress UIï¼Œé¸æ“‡ E2E æ¸¬è©¦ä¸¦é‹è¡Œï¼šnpm run cypress:open
æˆ–åœ¨ç„¡é ­æ¨¡å¼ä¸‹é‹è¡Œæ‰€æœ‰æ¸¬è©¦ï¼šnpm run cypress:run
å®Œæˆå¾Œè¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼šcd ..
å¾Œç«¯æ¸¬è©¦ (PHPUnit)é€²å…¥ Laravel å¾Œç«¯å®¹å™¨ï¼šdocker exec -it workflow-ai-backend bash
é‹è¡Œ PHPUnit æ¸¬è©¦ï¼š./vendor/bin/phpunit
é€€å‡ºå®¹å™¨ï¼šexit
ğŸ“ é–‹ç™¼ç­†è¨˜ (Development Notes)OpenAI API Key: AI Orchestrator ä¾è³´æ–¼ OpenAI API é€²è¡Œ Embedding å’Œ LLM åŠŸèƒ½ã€‚è«‹ç¢ºä¿æ‚¨çš„ OPENAI_API_KEY åœ¨æ ¹ç›®éŒ„çš„ .env æ–‡ä»¶ä¸­å·²æ­£ç¢ºè¨­å®šï¼Œå¦å‰‡ AI æœå‹™å°‡ç„¡æ³•æ­£å¸¸å·¥ä½œã€‚Faster-Whisper æ¨¡å‹: AI Orchestrator ä¸­çš„ faster-whisper æ¨¡å‹æœƒåœ¨é¦–æ¬¡é‹è¡Œæ™‚è‡ªå‹•ä¸‹è¼‰ï¼ˆé è¨­ç‚º tiny æ¨¡å‹ï¼‰ã€‚æ¨¡å‹æ–‡ä»¶å°‡å­˜å„²åœ¨ ai-orchestrator/data/whisper_models/ ç›®éŒ„ä¸­ã€‚å¦‚æœæ‚¨éœ€è¦ä½¿ç”¨æ›´å¤§æˆ–æ›´ç²¾ç¢ºçš„æ¨¡å‹ï¼ˆä¾‹å¦‚ base, small, medium, large-v2, large-v3ï¼‰ï¼Œè«‹ä¿®æ”¹æ ¹ç›®éŒ„çš„ .env æ–‡ä»¶ä¸­çš„ WHISPER_MODEL åƒæ•¸ã€‚Laravel Sanctum èˆ‡ CORS: ç‚ºäº†ç¢ºä¿å‰ç«¯èˆ‡å¾Œç«¯çš„èªè­‰æ­£å¸¸å·¥ä½œï¼ŒSANCTUM_STATEFUL_DOMAINS å’Œ SESSION_DOMAIN ç’°å¢ƒè®Šæ•¸å·²åœ¨ .env.example ä¸­é…ç½®ã€‚å®ƒå€‘å…è¨±è·¨åŸŸè«‹æ±‚åœ¨ç‰¹å®šåŸŸï¼ˆä¾‹å¦‚æ‚¨çš„å‰ç«¯åœ°å€ï¼‰ä¸Šå®‰å…¨åœ°ç™¼é€æ†‘è­‰ã€‚è·¯ç”±ä¿è­·: å‰ç«¯æ‡‰ç”¨ä¸­çš„æ•æ„Ÿè·¯ç”±ï¼ˆå¦‚ /documents, /voiceï¼‰å·²é…ç½®äº†è·¯ç”±å®ˆè¡›ï¼Œç¢ºä¿åªæœ‰å·²èªè­‰çš„ç”¨æˆ¶æ‰èƒ½è¨ªå•ã€‚æœªç™»å…¥çš„ç”¨æˆ¶å°‡è¢«é‡å®šå‘åˆ°ç™»å…¥é é¢ã€‚å¸Œæœ›é€™ä»½è©³ç´°çš„ README.md æ–‡ä»¶èƒ½å¹«åŠ©æ‚¨æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨é€™å€‹ Workflow AI Platform å°ˆæ¡ˆï¼